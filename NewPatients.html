<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Win Dental - Patient Registration & Consent</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, sans-serif;
    margin: 30px;
    line-height: 1.6;
    position: relative;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

.logo {
    width: 120px;
    height: auto;
}

.title {
    text-align: center;
    flex: 1;
}

/* Mobile adjustment */
@media (max-width: 768px) {
    .header {
        flex-direction: column;
        text-align: center;
    }

    .logo {
        margin-top: 10px;
    }
}

h1 {
    text-align: center;
}

h2 {
    text-align: center;
    margin-top: -25px;
}
    
.section {
    margin-top: 30px;
}

input, textarea, select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.inline {
    width: auto;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    border: 1px solid #ccc;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border-bottom: 1px solid #ccc;
    border-right: 1px solid #ccc;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
    margin: 0;
}

.checkbox-group label:nth-child(2n) {
    border-right: none;
}

.checkbox-group label:nth-last-child(-n + 2) {
    border-bottom: none;
}

.signature-box {
    border: 1px solid #000;
    height: 150px;
    margin-bottom: 10px;
}

button {
    padding: 8px 15px;
    margin-top: 5px;
}

.footer-version {
    text-align: right;
    margin-bottom: 10px;
    font-weight:300;
    font-size: 0.8em;
}  
    
.footer {
    text-align: center;
    margin-top: 40px;
    font-weight: bold;
}

#signature-pad {
  width: 100%;
  height: 200px;
  border: 1px solid #ccc;
  touch-action: none;
}

#pdfContent {
    padding: 40px;        /* space inside content */
    box-sizing: border-box;
    background: white;    /* ensures background is visible in PDF */
}       
</style>
</head>
<body>

<div id="pdfContent"> 
<div class="header">
    <div class="title">
        <h1>WIN DENTAL CLINIC</h1>
        <h2>New Patient Registration Form</h2>
        <h2>新病人登记表</h2>
    </div>
    <img src="Images/win-dental-logo.png" class="logo" alt="Win Dental Logo">
</div> 

<form id="newPTConsentForm">

<div class="section">
<h3>Personal Information</h3>

<label>Name/ 姓名/ Nama*</label>
<input type="text" id="name" name="name" required>

<label>NRIC/Passport No/ 身份证/护照号码/ No. Kad Pengenalan Passport*</label>
<input type="text" id="nric" name="nric" required>
    
<label>Birthday/ 生日/ Tarikh Lahir*</label>
<input type="date" id="birthday" name="birthday" required>

<label>Mobile Phone/ 手提电话/ Tel. Bimbit*</label>
<input type="text" id="mobile" name="mobile" required>

<label>Email/ 电邮/ E-mel*</label>
<input type="email" id="email" name="email" required>
    
<label>Home Tel/ 住家电话/ Tel.No.Rumah</label>
<input type="text" name="home">

<label>Address/ 地址/ Alamat</label>
<textarea id="address" name="address"></textarea>

<label>Postcode/ 邮编/ Poskod</label>
<input id="postcode" type="text" name="postcode">

<label>City/State/ 城市/州/ Bandar/Negeri</label>
<input id="city" type="text" name="city">

<label>Country/ 国家/ Negara</label>
<input id="country" type="text" name="country">

<label>Occupation/ 职业/ Pekerjaan</label>
<input type="text" name="occupation">

<label>Language Spoken/ 语言口语/ Bahasa Pertuturan</label>
<input type="text" name="language_spoken">

<label>Language Written/ 写的语言/ Penulisan</label>
<input type="text" name="language_written">
</div>

<div class="section">
<h3>Medical Condition/ 请告知您的病情</h3>

<div class="checkbox-group">
<label>High Blood Pressure<input type="checkbox"></label>
<label>Diabetes Mellitus<input type="checkbox"></label>
<label>Hypercholesterolemia<input type="checkbox"></label>
<label>Heart Defect<input type="checkbox"></label>
<label>Rheumatic Fever<input type="checkbox"></label>
<label>Heart Murmur<input type="checkbox"></label>
<label>Mitral Valve Prolapse<input type="checkbox"></label>
<label>Angina / Chest Pain<input type="checkbox"></label>
<label>Stroke<input type="checkbox"></label>
<label>Blood Disease<input type="checkbox"></label>
<label>Haemophilia<input type="checkbox"></label>
<label>Epilepsy<input type="checkbox"></label>
<label>Thyroid Disease<input type="checkbox"></label>
<label>Rheumatoid Arthritis<input type="checkbox"></label>
<label>G6PD Deficiency<input type="checkbox"></label>
<label>Hepatitis / Jaundice<input type="checkbox"></label>
<label>Hepatitis B Carrier<input type="checkbox"></label>
<label>Liver Disease<input type="checkbox"></label>
<label>Gastric Problem<input type="checkbox"></label>
<label>Tumours / Growths<input type="checkbox"></label>
<label>Tuberculosis<input type="checkbox"></label>
<label>Respiratory Problem<input type="checkbox"></label>
<label>Asthma<input type="checkbox"></label>
<label>Sinus Problem<input type="checkbox"></label>
<label>Systemic Lupus Erythematous<input type="checkbox"></label>
<label>Kidney Disease<input type="checkbox"></label>
</div>

<br>
<label>Drug Allergies/ 患者有药物过敏史</label>
<textarea name="allergy"></textarea>

<div class="section">
<p>
<h3>Informed Consent</h3>
<p>
You as the patient have the right to accept or reject dental treatment recommended by your dentist. 
Prior to consenting to treatment, you should carefully consider the anticipated benefits and commonly known risks of the recommended procedure, 
alternative treatments, or the option of no treatment.</br> 
Please do not consent to treatment unless and until you discuss potential benefits, risks, 
and complications with your dentist and all of your questions are answered. By consenting to treatment, 
you acknowledge your willingness to accept known risks and complications, no matter how slight the probability of occurrence. </br>
It is very important that you provide your dentist with accurate information before, during and after treatment. 
It is equally important that you follow your dentist’s advice and recommendations regarding medication, 
pre and post treatment instructions, referrals to other dentists or specialists, and return for scheduled appointments. If you fail to
follow the advice of your dentist, you may increase the chances of a poor outcome.</br>
If you are a woman on oral birth control medication you must consider the fact that antibiotics might make oral birth control less effective. 
Please consult with your physician before relying on oral birth control medication if your dentist prescribes, or if you are taking antibiotics.
</p>

<h3>1. EXAMINATION AND X-RAYS</h3>    
<p>
I understand that the initial visit may require radiographs in order to complete the examination, diagnosis, and treatment plan.
</p>
<h3>2. DRUGS, MEDICATION, AND SEDATION</h3>    
<p>
I have been informed and understand that antibiotic, analgesics, and other medications can cause allergic reactions causing redness, 
swelling of tissues, pain, itching, vomiting, and/or anaphylactic shock (severe allergic reaction). 
They may cause drowsiness and a lack of awareness and coordination, which can be increased by the use of alcohol or other drugs. 
I understand and fully agree not to operate any vehicle or hazardous device for at least 12 hours or until fully recovered from the effects 
of the anesthetic medication and drugs that may have been given me in the office for my treatment. 
I understand that failure to take medications prescribed for me in the manner prescribed may offer risks of continued or aggravated infection, pain, 
and potential resistance to effect treatment of my condition. I understand that antibiotics can reduce the effectiveness of oral contraceptives.    
</p>    
<h3>3. CHANGES IN TREATMENT PLAN</h3>
<p>
I understand that during treatment, it may be necessary to change or add procedures because found while working on teeth that were not discovered 
during the initial examination, the most common being root canal therapy following routine restorative procedures. 
I give my permission to the Dentist to make any or all changes and additions as necessary.    
</p>
<h3>4. TEMPOROMANDIBULAR JOINT DYSFUNCTIONS (TMJ)</h3>    
<p>
I understand that symptoms of popping, clicking, locking and pain can intensify or develop in the joint of the lower (near the ear) subsequent to 
routine dental treatment wherein the mouth is held in the open position. However, symptoms of TMJ associated with dental treatment are usually 
temporary in nature and well tolerated by most patients. I understand that should the need for treatment arise, I will be referred to a specialist for treatment, 
the cost of which is my responsibility.    
</p>
<h3>5. FILLINGS AND RESTORATIONS</h3>
<p>
I understand that care must be exercised in chewing on the new filling during the first 24 hours to avoid breakage, 
and tooth sensitivity is a common after-effect of a newly placed filling.
</p>
<h3>6. MEDICAL DATA, COLLECTION, USE, AND DISCLOSURE</h3>
<p>
I consent to Win Dental Sdn Bhd collecting, using, processing, storing, and disclosing my personal and medical information for the purposes of Diagnosis and treatment,
Medical record keeping, Billing and insurance, Referrals and continuity of care, Legal, regulatory, and compliance requirements. 
I understand my information may be disclosed to Hospitals, specialists, or laboratories, Professional indemnity insurers, 
Regulatory authorities or courts when required by law
</p>

<label>
<input type="checkbox" required class="inline">
<b>I have read and agree to the above consent terms.*</b>
</label>

<div class="section">
<label>Patient Name</label>
<input type="text" id="patient_name" name="patient_name">

<label>Parent/Legal Guardian(For patient is under 18 years old)</label>
<input type="text" name="guardian">

<label>Signature Date</label>
<input type="date" id="dateInput" name="date">

<h3>Signature</h3>
<canvas id="signature-pad" class="signature-box"></canvas>
</div>

<button type="button" onclick="clearSignature()">Clear Signature</button>
<button type="submit">Submit</button>

<div class="footer-version">
Version 1.1
</div> 
    
<div class="footer">
WIN DENTAL SDN. BHD. (1579600-P)
</div></div></div>
</form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    
window.onload = function() {
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  const name = getQueryParam('name') || '';  
  const mobile = getQueryParam('mobile') || '';
  const birthday = getQueryParam('birthday') || '';  
  const nric = getQueryParam('nric') || '';
  const email = getQueryParam('email') || '';  
  const address = getQueryParam('address') || '';  
  const postcode = getQueryParam('postcode') || '';  
  const city = getQueryParam('city') || '';  
  const country = getQueryParam('country') || '';  

  if (name) {
    document.getElementById('name').value = name;
    document.getElementById('patient_name').value = name;
  }
  if (mobile) document.getElementById('mobile').value = mobile;
  if (birthday) document.getElementById('birthday').value = birthday;
  if (nric) document.getElementById('nric').value = nric;
  if (email) document.getElementById('email').value = email;
  if (address) document.getElementById('address').value = address;
  if (postcode) document.getElementById('postcode').value = postcode;
  if (city) document.getElementById('city').value = city;
  if (country) document.getElementById('country').value = country;
}   
    
const mainNameField = document.querySelector('input[name="name"]');
const patientNameField = document.querySelector('input[name="patient_name"]');
mainNameField.addEventListener('input', () => {
    patientNameField.value = mainNameField.value;
});
    
// Signature Canvas
const canvas = document.getElementById('signature-pad');
const ctx = canvas.getContext('2d');
let drawing = false;

function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    ctx.scale(ratio, ratio);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Prevent scrolling    
canvas.addEventListener("touchstart", e => e.preventDefault(), { passive: false });
canvas.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

// Mouse events
canvas.addEventListener('mousedown', e => { drawing = true; draw(e); });
canvas.addEventListener('mousemove', draw);
canvas.addEventListener('mouseup', () => { drawing = false; ctx.beginPath(); });
canvas.addEventListener('mouseout', () => { drawing = false; ctx.beginPath(); });

// Touch events
canvas.addEventListener('touchstart', e => {
    drawing = true;
    const touch = e.touches[0];
    drawTouch(touch);
});
canvas.addEventListener('touchmove', e => {
    if (!drawing) return;
    const touch = e.touches[0];
    drawTouch(touch);
});
canvas.addEventListener('touchend', () => { drawing = false; ctx.beginPath(); });

function draw(e) {
    if (!drawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function drawTouch(touch) {
    const rect = canvas.getBoundingClientRect();
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(touch.clientX - rect.left, touch.clientY - rect.top);
}
    
function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function isCanvasEmpty(canvas) {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
}

// Set today's date
document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

// Form Submission and PDF
document.getElementById("newPTConsentForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    if (!this.checkValidity()) {
        alert("Please fill in all required fields.");
        return;
    }
    if (isCanvasEmpty(canvas)) {
        alert("Please provide your signature before submitting.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const element = document.getElementById("pdfContent");

    const canvasImage = await html2canvas(element, { 
        scale: window.devicePixelRatio || 2, 
        scrollY: -window.scrollY,  // ensures correct position
        useCORS: true              // in case images are cross-origin
    });
    const imgData = canvasImage.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvasImage.height * pdfWidth) / canvasImage.width;

    let heightLeft = pdfHeight;
    let position = 0;
    
    while (heightLeft > 0) {
        pdf.addImage(imgData, "PNG", 0, position, pdfWidth, pdfHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();
        if (heightLeft > 0) pdf.addPage();
        position -= pdf.internal.pageSize.getHeight();
    }

    // Get name field value
    const patientName = document.querySelector('input[name="name"]').value.trim().replace(/\s+/g, '_');
    
    // Generate timestamp
    const now = new Date();
    const timestamp = now.getFullYear() + '-' +
                      String(now.getMonth() + 1).padStart(2, '0') +
                      String(now.getDate()).padStart(2, '0') +
                      String(now.getHours()).padStart(2, '0')  +
                      String(now.getMinutes()).padStart(2, '0') +
                      String(now.getSeconds()).padStart(2, '0');
    
    // Combine for filename
    const filename = `${timestamp}NewPatient_${patientName}.pdf`;
    
    // Save PDF
    pdf.save(filename);

    this.reset();
    //clearSignature():
    //form.reset();
    alert("New Registration PDF Generated!");
});
</script>

</body>
</html>
