<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Win Dental - Patient Registration & Consent</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
    font-family: Arial, sans-serif;
    margin: 30px;
    line-height: 1.6;
    background-image: url('/images/win-dental-logo.png'); /* adjust path */
    background-repeat: no-repeat;
    background-position: top 20px left 20px;
    background-size: 150px; /* adjust size */
    opacity: 0.15;
}

h1, h2 {
    text-align: center;
}

.section {
    margin-top: 30px;
}

input, textarea, select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.inline {
    width: auto;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    border: 1px solid #ccc;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px;
    border-bottom: 1px solid #ccc;
    border-right: 1px solid #ccc;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
    margin: 0;
}

.checkbox-group label:nth-child(2n) {
    border-right: none;
}

.checkbox-group label:nth-last-child(-n + 2) {
    border-bottom: none;
}

.signature-box {
    border: 1px solid #000;
    height: 150px;
    margin-bottom: 10px;
}

button {
    padding: 8px 15px;
    margin-top: 5px;
}

.footer {
    text-align: center;
    margin-top: 40px;
    font-weight: bold;
}

#signature-pad {
  width: 100%;
  height: 200px;
  border: 1px solid #ccc;
  touch-action: none;
}    
</style>
</head>
<body>

<div id="pdfContent">
<h1>WIN DENTAL CLINIC</h1>
<h2>New Patient Registration Form</h2>

<form id="newPTConsentForm">

<div class="section">
<h3>Personal Information</h3>

<label>Name*</label>
<input type="text" name="name" required>

<label>Birthday*</label>
<input type="date" name="birthday" required>

<label>Mobile Phone*</label>
<input type="text" name="mobile" required>

<label>Home Tel</label>
<input type="text" name="home">

<label>Email*</label>
<input type="email" name="email" required>

<label>NRIC / Passport No*</label>
<input type="text" name="nric" required>

<label>Address</label>
<textarea name="address"></textarea>

<label>Postcode</label>
<input type="text" name="postcode">

<label>City / State</label>
<input type="text" name="city">

<label>Country</label>
<input type="text" name="country">

<label>Occupation</label>
<input type="text" name="occupation">

<label>Language Spoken</label>
<input type="text" name="language_spoken">

<label>Language Written</label>
<input type="text" name="language_written">
</div>

<div class="section">
<h3>Medical Condition</h3>

<div class="checkbox-group">
<label>High Blood Pressure<input type="checkbox"></label>
<label>Diabetes Mellitus<input type="checkbox"></label>
<label>Hypercholesterolemia<input type="checkbox"></label>
<label>Heart Defect<input type="checkbox"></label>
<label>Rheumatic Fever<input type="checkbox"></label>
<label>Heart Murmur<input type="checkbox"></label>
<label>Mitral Valve Prolapse<input type="checkbox"></label>
<label>Angina / Chest Pain<input type="checkbox"></label>
<label>Stroke<input type="checkbox"></label>
<label>Blood Disease<input type="checkbox"></label>
<label>Haemophilia<input type="checkbox"></label>
<label>Epilepsy<input type="checkbox"></label>
<label>Thyroid Disease<input type="checkbox"></label>
<label>Rheumatoid Arthritis<input type="checkbox"></label>
<label>G6PD Deficiency<input type="checkbox"></label>
<label>Hepatitis / Jaundice<input type="checkbox"></label>
<label>Hepatitis B Carrier<input type="checkbox"></label>
<label>Liver Disease<input type="checkbox"></label>
<label>Gastric Problem<input type="checkbox"></label>
<label>Tumours / Growths<input type="checkbox"></label>
<label>Tuberculosis<input type="checkbox"></label>
<label>Respiratory Problem<input type="checkbox"></label>
<label>Asthma<input type="checkbox"></label>
<label>Sinus Problem<input type="checkbox"></label>
<label>Systemic Lupus Erythematous<input type="checkbox"></label>
<label>Kidney Disease<input type="checkbox"></label>
</div>

<br>
<label>Drug Allergies</label>
<textarea name="allergy"></textarea>

<div class="section">
<h3>Informed Consent</h3>
<p>
I understand that dental treatment may involve risks and benefits. 
I acknowledge that I have discussed treatment options with the dentist 
and consent to the recommended procedures.
</p>

<p>
I understand medications may cause allergic reactions and I agree to follow 
all instructions given by the dentist.
</p>

<label>
<input type="checkbox" required class="inline">
<b>I have read and agree to the above consent terms.*</b>
</label>

<div class="section">
<label>Patient Name</label>
<input type="text" name="patient_name">

<label>Parent/Legal Guardian (if under 18)</label>
<input type="text" name="guardian">

<label>Date</label>
<input type="date" id="dateInput" name="date">

<h3>Signature</h3>
<canvas id="signature-pad" class="signature-box"></canvas>
</div>

<button type="button" onclick="clearSignature()">Clear Signature</button>
<button type="submit">Submit</button>

<div class="footer">
WIN DENTAL SDN. BHD. (1579600-P)
</div></div></div>
</form>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// Signature Canvas
document.body.style.overflow = "hidden";
document.body.style.overflow = "auto";
const canvas = document.getElementById('signature-pad');
const ctx = canvas.getContext('2d');
let drawing = false;
canvas.addEventListener("touchstart", e => e.preventDefault(), { passive: false });
canvas.addEventListener("touchmove", e => e.preventDefault(), { passive: false });

function resizeCanvas() {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = canvas.offsetHeight * ratio;
    ctx.scale(ratio, ratio);
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

canvas.addEventListener('mousedown', () => drawing = true);
canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mouseout', () => drawing = false);
canvas.addEventListener('mousemove', draw);

function draw(e) {
    if (!drawing) return;
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
}

function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function isCanvasEmpty(canvas) {
    const blank = document.createElement('canvas');
    blank.width = canvas.width;
    blank.height = canvas.height;
    return canvas.toDataURL() === blank.toDataURL();
}

// Set today's date
document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];

// Form Submission and PDF
document.getElementById("newPTConsentForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    if (!this.checkValidity()) {
        alert("Please fill in all required fields.");
        return;
    }
    if (isCanvasEmpty(canvas)) {
        alert("Please provide your signature before submitting.");
        return;
    }

    const { jsPDF } = window.jspdf;
    const element = document.getElementById("pdfContent");

    const canvasImage = await html2canvas(element, { scale: 2 });
    const imgData = canvasImage.toDataURL("image/png");

    const pdf = new jsPDF("p", "mm", "a4");
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (canvasImage.height * pdfWidth) / canvasImage.width;

    let heightLeft = pdfHeight;
    let position = 0;
    
    while (heightLeft > 0) {
        pdf.addImage(imgData, "PNG", 0, position, pdfWidth, pdfHeight);
        heightLeft -= pdf.internal.pageSize.getHeight();
        if (heightLeft > 0) pdf.addPage();
        position -= pdf.internal.pageSize.getHeight();
    }

    // Get name field value
    const patientName = document.querySelector('input[name="name"]').value.trim().replace(/\s+/g, '_');
    
    // Generate timestamp
    const now = new Date();
    const timestamp = now.getFullYear() + '-' +
                      String(now.getMonth() + 1).padStart(2, '0') + '-' +
                      String(now.getDate()).padStart(2, '0') + '_' +
                      String(now.getHours()).padStart(2, '0') + '-' +
                      String(now.getMinutes()).padStart(2, '0') + '-' +
                      String(now.getSeconds()).padStart(2, '0');
    
    // Combine for filename
    const filename = `Patient_Registration_${patientName}_${timestamp}.pdf`;
    
    // Save PDF
    pdf.save(filename);


    alert("Registration submitted!");
});
</script>

</body>
</html>
